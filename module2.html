<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 2 - Analyse Concurrentielle</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; }
        h1 { color: #4b3e12; font-size: 24px; margin-bottom: 8px; }
        h2 { color: #4b3e12; font-size: 18px; margin-bottom: 16px; }
        h3 { color: #4b3e12; font-size: 16px; margin-bottom: 12px; }
        .subtitle { color: #a4a4a4; font-size: 14px; }
        .grid { display: grid; gap: 16px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        label { display: block; font-size: 14px; font-weight: 500; color: #4b3e12; margin-bottom: 8px; }
        input, select { width: 100%; padding: 10px 16px; border: 1px solid #a4a4a4; border-radius: 8px; font-size: 14px; }
        button { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-primary { background: #cdaa36; color: white; }
        .competitor-card { padding: 20px; border-radius: 8px; border: 2px solid #cdaa36; background: #fef9f0; margin-bottom: 16px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e5e5; }
        th { background: #fef9f0; color: #4b3e12; font-weight: 600; font-size: 14px; }
        td { font-size: 14px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mt-4 { margin-top: 16px; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 600; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .summary-card { padding: 16px; background: white; border-radius: 8px; border: 1px solid #e5e5e5; }
        .big-number { font-size: 24px; font-weight: bold; color: #cdaa36; }
        .alert { padding: 12px; background: #fef9f0; border-radius: 8px; border: 1px solid #cdaa36; margin-bottom: 16px; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        const CompetitiveAnalyzer = () => {
            const loadFromStorage = () => {
                try {
                    const saved = localStorage.getItem('module2_data');
                    if (saved) return JSON.parse(saved);
                } catch (e) {
                    console.error('Erreur lecture localStorage:', e);
                }
                return null;
            };

            const initialData = loadFromStorage();
            
            const [propertyName, setPropertyName] = useState(initialData?.propertyName || '');
            const [cleaningFees, setCleaningFees] = useState(initialData?.cleaningFees || {
                airbnb: '',
                booking: ''
            });
            const [commissions, setCommissions] = useState(initialData?.commissions || {
                airbnb: '15.5',
                booking: '18'
            });
            const [data, setData] = useState(initialData?.data || {
                competitors: Array(5).fill(null).map((_, i) => ({
                    name: `Concurrent ${i + 1}`,
                    type: '',
                    airbnbLink: '',
                    airbnbNote: '',
                    bookingLink: '',
                    bookingNote: '',
                    lowSeason: { 
                        airbnb: { night1: '', night3: '' },
                        booking: { night1: '', night3: '' }
                    },
                    midSeason: { 
                        airbnb: { night1: '', night3: '' },
                        booking: { night1: '', night3: '' }
                    },
                    highSeason: { 
                        airbnb: { night1: '', night3: '' },
                        booking: { night1: '', night3: '' }
                    },
                    events: { 
                        airbnb: { night1: '', night3: '' },
                        booking: { night1: '', night3: '' }
                    }
                }))
            });

            useEffect(() => {
                try {
                    localStorage.setItem('module2_data', JSON.stringify({
                        propertyName,
                        cleaningFees,
                        commissions,
                        data
                    }));
                } catch (e) {
                    console.error('Erreur sauvegarde localStorage:', e);
                }
            }, [propertyName, cleaningFees, commissions, data]);

            const seasons = [
                { key: 'lowSeason', label: 'Basse Saison', color: '#87CEEB' },
                { key: 'midSeason', label: 'Moyenne Saison', color: '#FFA500' },
                { key: 'highSeason', label: 'Haute Saison', color: '#FF6347' },
                { key: 'events', label: '√âv√©nementiel', color: '#9370DB' }
            ];

            const durations = [
                { key: 'night1', label: '1 nuit', nights: 1 },
                { key: 'night3', label: '3 nuits', nights: 3 }
            ];

            const updateCompetitor = (index, field, value) => {
                const newData = { ...data };
                newData.competitors[index][field] = value;
                setData(newData);
            };

            const updatePrice = (competitorIdx, season, platform, duration, value) => {
                const newData = { ...data };
                newData.competitors[competitorIdx][season][platform][duration] = value;
                setData(newData);
            };

            // Calculs avec la VRAIE formule : (Prix total - Frais m√©nage) / Dur√©e * (1 - Commission)
            const calculateAverages = useMemo(() => {
                const result = {};
                const commAirbnb = parseFloat(commissions.airbnb) / 100 || 0.155;
                const commBooking = parseFloat(commissions.booking) / 100 || 0.18;
                const cleanAirbnb = parseFloat(cleaningFees.airbnb) || 0;
                const cleanBooking = parseFloat(cleaningFees.booking) || 0;
                
                seasons.forEach(season => {
                    result[season.key] = { airbnb: {}, booking: {}, stats: {} };

                    durations.forEach(duration => {
                        const nights = duration.nights;
                        
                        const airbnbPrices = data.competitors
                            .map(c => {
                                const grossPrice = parseFloat(c[season.key].airbnb[duration.key]);
                                if (isNaN(grossPrice) || grossPrice <= 0) return null;
                                const netPerNight = (grossPrice - cleanAirbnb) / nights * (1 - commAirbnb);
                                return netPerNight > 0 ? netPerNight : null;
                            })
                            .filter(p => p !== null);
                        
                        const bookingPrices = data.competitors
                            .map(c => {
                                const grossPrice = parseFloat(c[season.key].booking[duration.key]);
                                if (isNaN(grossPrice) || grossPrice <= 0) return null;
                                const netPerNight = (grossPrice - cleanBooking) / nights * (1 - commBooking);
                                return netPerNight > 0 ? netPerNight : null;
                            })
                            .filter(p => p !== null);

                        result[season.key].airbnb[duration.key] = airbnbPrices.length > 0 
                            ? airbnbPrices.reduce((a, b) => a + b, 0) / airbnbPrices.length 
                            : 0;
                        
                        result[season.key].booking[duration.key] = bookingPrices.length > 0 
                            ? bookingPrices.reduce((a, b) => a + b, 0) / bookingPrices.length 
                            : 0;

                        const allPrices = [...airbnbPrices, ...bookingPrices];
                        if (allPrices.length > 0) {
                            result[season.key].stats[duration.key] = {
                                min: Math.min(...allPrices),
                                tendance: allPrices.reduce((a, b) => a + b, 0) / allPrices.length,
                                max: Math.max(...allPrices)
                            };
                        } else {
                            result[season.key].stats[duration.key] = { min: 0, tendance: 0, max: 0 };
                        }
                    });
                });

                return result;
            }, [data, cleaningFees, commissions]);

            const priceGrid = useMemo(() => {
                const grid = {};
                seasons.forEach(season => {
                    const allStats = durations.map(d => calculateAverages[season.key].stats[d.key]).filter(s => s.tendance > 0);
                    if (allStats.length > 0) {
                        const allTendances = allStats.map(s => s.tendance);
                        grid[season.key] = {
                            min: Math.min(...allStats.map(s => s.min)),
                            tendance: allTendances.reduce((a, b) => a + b, 0) / allTendances.length,
                            max: Math.max(...allStats.map(s => s.max))
                        };
                    } else {
                        grid[season.key] = { min: 0, tendance: 0, max: 0 };
                    }
                });
                return grid;
            }, [calculateAverages]);

            const exportToExcel = () => {
                const wb = XLSX.utils.book_new();
                
                const ws1Data = [['ANALYSE CONCURRENTIELLE'], [], ['Bien:', propertyName || 'Non renseign√©'], ['Frais m√©nage Airbnb:', cleaningFees.airbnb + '‚Ç¨'], ['Frais m√©nage Booking:', cleaningFees.booking + '‚Ç¨'], ['Commission Airbnb:', commissions.airbnb + '%'], ['Commission Booking:', commissions.booking + '%'], [], ['Concurrent', 'Type', 'Note Airbnb', 'Note Booking', 'Lien Airbnb', 'Lien Booking', 'P√©riode', 'Dur√©e', 'Prix Airbnb (‚Ç¨)', 'Prix Booking (‚Ç¨)']];
                
                data.competitors.forEach(comp => {
                    seasons.forEach(season => {
                        durations.forEach(duration => {
                            ws1Data.push([
                                comp.name,
                                comp.type || '',
                                comp.airbnbNote || '',
                                comp.bookingNote || '',
                                comp.airbnbLink || '',
                                comp.bookingLink || '',
                                season.label,
                                duration.label,
                                comp[season.key].airbnb[duration.key] || '',
                                comp[season.key].booking[duration.key] || ''
                            ]);
                        });
                    });
                });
                
                const ws1 = XLSX.utils.aoa_to_sheet(ws1Data);
                XLSX.utils.book_append_sheet(wb, ws1, 'Donn√©es brutes');
                
                const ws2Data = [['PRIX NETS PAR NUIT'], [], ['P√©riode', 'Dur√©e', 'Airbnb Net/nuit', 'Booking Net/nuit', 'MIN', 'TENDANCE', 'MAX']];
                
                seasons.forEach(season => {
                    durations.forEach(duration => {
                        const stats = calculateAverages[season.key].stats[duration.key];
                        ws2Data.push([
                            season.label,
                            duration.label,
                            calculateAverages[season.key].airbnb[duration.key].toFixed(2),
                            calculateAverages[season.key].booking[duration.key].toFixed(2),
                            stats.min.toFixed(2),
                            stats.tendance.toFixed(2),
                            stats.max.toFixed(2)
                        ]);
                    });
                });
                
                const ws2 = XLSX.utils.aoa_to_sheet(ws2Data);
                XLSX.utils.book_append_sheet(wb, ws2, 'Prix nets');
                
                const ws3Data = [['GRILLE TARIFAIRE RECOMMAND√âE'], [], ['P√©riode', 'Minimum (‚Ç¨)', 'Tendance (‚Ç¨)', 'Maximum (‚Ç¨)']];
                seasons.forEach(season => {
                    ws3Data.push([season.label, priceGrid[season.key].min.toFixed(2), priceGrid[season.key].tendance.toFixed(2), priceGrid[season.key].max.toFixed(2)]);
                });
                
                const ws3 = XLSX.utils.aoa_to_sheet(ws3Data);
                XLSX.utils.book_append_sheet(wb, ws3, 'Grille tarifaire');
                
                XLSX.writeFile(wb, 'analyse_concurrentielle.xlsx');
            };

            return (
                <div className="container">
                    <div className="mb-4">
                        <h1>Module 2 - Analyse Concurrentielle</h1>
                        <p className="subtitle">Analysez vos concurrents pour d√©finir votre grille tarifaire</p>
                        <p style={{fontSize: '12px', color: '#cdaa36', marginTop: '8px'}}>
                            üíæ Vos donn√©es sont sauvegard√©es automatiquement
                        </p>
                    </div>

                    <div className="card">
                        <h2>üìã Configuration</h2>
                        <div className="grid grid-3 mb-4">
                            <div>
                                <label>Nom de votre bien</label>
                                <input 
                                    type="text" 
                                    value={propertyName} 
                                    onChange={(e) => setPropertyName(e.target.value)} 
                                    placeholder="Ex: Studio Tonnerre de Brest" 
                                />
                            </div>
                            <div>
                                <label>Frais m√©nage Airbnb (‚Ç¨)</label>
                                <input 
                                    type="number" 
                                    value={cleaningFees.airbnb} 
                                    onChange={(e) => setCleaningFees({...cleaningFees, airbnb: e.target.value})} 
                                    placeholder="20"
                                />
                            </div>
                            <div>
                                <label>Frais m√©nage Booking (‚Ç¨)</label>
                                <input 
                                    type="number" 
                                    value={cleaningFees.booking} 
                                    onChange={(e) => setCleaningFees({...cleaningFees, booking: e.target.value})} 
                                    placeholder="20"
                                />
                            </div>
                            <div>
                                <label>Commission Airbnb (%)</label>
                                <input 
                                    type="number" 
                                    value={commissions.airbnb} 
                                    onChange={(e) => setCommissions({...commissions, airbnb: e.target.value})} 
                                    placeholder="15.5"
                                    step="0.1"
                                />
                            </div>
                            <div>
                                <label>Commission Booking (%)</label>
                                <input 
                                    type="number" 
                                    value={commissions.booking} 
                                    onChange={(e) => setCommissions({...commissions, booking: e.target.value})} 
                                    placeholder="18"
                                    step="0.1"
                                />
                            </div>
                        </div>
                        
                        <div className="alert">
                            <strong>üìù Mode d'emploi :</strong> Saisissez le <strong>prix TOTAL du s√©jour</strong> affich√© (ex: 150‚Ç¨ pour 3 nuits). Le calcul utilise la formule : <code>(Prix total - Frais m√©nage) √∑ Dur√©e √ó (1 - Commission%)</code>
                        </div>
                    </div>

                    <div className="card">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                            <h2 style={{margin: 0}}>üîç Vos Concurrents</h2>
                            <button onClick={exportToExcel} className="btn-primary">
                                üì• Export Excel
                            </button>
                        </div>

                        {data.competitors.map((competitor, idx) => (
                            <div key={idx} className="competitor-card">
                                <div className="grid grid-2 mb-4">
                                    <div>
                                        <label>Nom du concurrent {idx + 1}</label>
                                        <input 
                                            type="text" 
                                            value={competitor.name} 
                                            onChange={(e) => updateCompetitor(idx, 'name', e.target.value)} 
                                            placeholder={`Concurrent ${idx + 1}`}
                                        />
                                    </div>
                                    <div>
                                        <label>Type de bien</label>
                                        <input 
                                            type="text" 
                                            value={competitor.type} 
                                            onChange={(e) => updateCompetitor(idx, 'type', e.target.value)} 
                                            placeholder="Studio, T2, T3..."
                                        />
                                    </div>
                                </div>
                                <div className="grid grid-2 mb-4">
                                    <div className="grid" style={{gridTemplateColumns: '2fr 1fr', gap: '8px'}}>
                                        <div>
                                            <label>Lien Airbnb</label>
                                            <input 
                                                type="url" 
                                                value={competitor.airbnbLink} 
                                                onChange={(e) => updateCompetitor(idx, 'airbnbLink', e.target.value)} 
                                                placeholder="https://airbnb.com/..."
                                            />
                                        </div>
                                        <div>
                                            <label>Note /5</label>
                                            <input 
                                                type="number" 
                                                value={competitor.airbnbNote} 
                                                onChange={(e) => updateCompetitor(idx, 'airbnbNote', e.target.value)} 
                                                placeholder="4.8"
                                                step="0.1"
                                                min="0"
                                                max="5"
                                            />
                                        </div>
                                    </div>
                                    <div className="grid" style={{gridTemplateColumns: '2fr 1fr', gap: '8px'}}>
                                        <div>
                                            <label>Lien Booking</label>
                                            <input 
                                                type="url" 
                                                value={competitor.bookingLink} 
                                                onChange={(e) => updateCompetitor(idx, 'bookingLink', e.target.value)} 
                                                placeholder="https://booking.com/..."
                                            />
                                        </div>
                                        <div>
                                            <label>Note /10</label>
                                            <input 
                                                type="number" 
                                                value={competitor.bookingNote} 
                                                onChange={(e) => updateCompetitor(idx, 'bookingNote', e.target.value)} 
                                                placeholder="9.2"
                                                step="0.1"
                                                min="0"
                                                max="10"
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-4">
                                    {seasons.map(season => (
                                        <div key={season.key}>
                                            <h3 style={{fontSize: '14px', marginBottom: '12px', color: season.color}}>
                                                {season.label}
                                            </h3>
                                            {durations.map(duration => (
                                                <div key={duration.key} className="mb-2">
                                                    <label style={{fontSize: '12px'}}>{duration.label}</label>
                                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '4px'}}>
                                                        <input 
                                                            type="number" 
                                                            value={competitor[season.key].airbnb[duration.key]} 
                                                            onChange={(e) => updatePrice(idx, season.key, 'airbnb', duration.key, e.target.value)} 
                                                            placeholder="Airbnb"
                                                            style={{fontSize: '12px', padding: '6px 8px'}}
                                                        />
                                                        <input 
                                                            type="number" 
                                                            value={competitor[season.key].booking[duration.key]} 
                                                            onChange={(e) => updatePrice(idx, season.key, 'booking', duration.key, e.target.value)} 
                                                            placeholder="Booking"
                                                            style={{fontSize: '12px', padding: '6px 8px'}}
                                                        />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="card">
                        <h2>üìä Analyse des Prix Nets par Nuit</h2>
                        <div style={{overflowX: 'auto'}}>
                            <table>
                                <thead>
                                    <tr>
                                        <th>P√©riode</th>
                                        <th>Dur√©e</th>
                                        <th className="text-center">Airbnb Net /nuit (‚Ç¨)</th>
                                        <th className="text-center">Booking Net /nuit (‚Ç¨)</th>
                                        <th className="text-center" style={{background: '#ffebee', color: '#c62828'}}>MIN</th>
                                        <th className="text-center" style={{background: '#e8f5e9', color: '#2e7d32'}}>TENDANCE</th>
                                        <th className="text-center" style={{background: '#e3f2fd', color: '#1565c0'}}>MAX</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {seasons.map(season => 
                                        durations.map((duration, dIdx) => {
                                            const stats = calculateAverages[season.key].stats[duration.key];
                                            const airbnb = calculateAverages[season.key].airbnb[duration.key];
                                            const booking = calculateAverages[season.key].booking[duration.key];
                                            
                                            return (
                                                <tr key={`${season.key}-${duration.key}`}>
                                                    {dIdx === 0 && (
                                                        <td rowSpan={durations.length} style={{fontWeight: '600', color: season.color}}>
                                                            {season.label}
                                                        </td>
                                                    )}
                                                    <td>{duration.label}</td>
                                                    <td className="text-center" style={{color: '#4b3e12', fontWeight: '500'}}>
                                                        {airbnb > 0 ? airbnb.toFixed(2) : '-'}
                                                    </td>
                                                    <td className="text-center" style={{color: '#4b3e12', fontWeight: '500'}}>
                                                        {booking > 0 ? booking.toFixed(2) : '-'}
                                                    </td>
                                                    <td className="text-center font-bold" style={{color: '#c62828'}}>
                                                        {stats.min > 0 ? stats.min.toFixed(2) : '-'}
                                                    </td>
                                                    <td className="text-center font-bold" style={{color: '#2e7d32'}}>
                                                        {stats.tendance > 0 ? stats.tendance.toFixed(2) : '-'}
                                                    </td>
                                                    <td className="text-center font-bold" style={{color: '#1565c0'}}>
                                                        {stats.max > 0 ? stats.max.toFixed(2) : '-'}
                                                    </td>
                                                </tr>
                                            );
                                        })
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="card">
                        <h2>üéØ Grille Tarifaire Recommand√©e</h2>
                        <p className="subtitle mb-4">Prix nets par nuit √† appliquer (MIN / TENDANCE / MAX)</p>
                        
                        <div className="summary-grid">
                            {seasons.map(season => (
                                <div key={season.key} className="summary-card" style={{borderTop: `4px solid ${season.color}`}}>
                                    <div style={{fontSize: '14px', fontWeight: '600', color: season.color, marginBottom: '12px'}}>
                                        {season.label}
                                    </div>
                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px', textAlign: 'center'}}>
                                        <div>
                                            <div style={{fontSize: '11px', color: '#c62828', fontWeight: '600'}}>MIN</div>
                                            <div style={{fontSize: '18px', fontWeight: 'bold', color: '#c62828'}}>
                                                {priceGrid[season.key].min > 0 ? priceGrid[season.key].min.toFixed(0) : '-'}
                                            </div>
                                        </div>
                                        <div>
                                            <div style={{fontSize: '11px', color: '#2e7d32', fontWeight: '600'}}>TENDANCE</div>
                                            <div className="big-number">
                                                {priceGrid[season.key].tendance > 0 ? priceGrid[season.key].tendance.toFixed(0) : '-'}
                                            </div>
                                        </div>
                                        <div>
                                            <div style={{fontSize: '11px', color: '#1565c0', fontWeight: '600'}}>MAX</div>
                                            <div style={{fontSize: '18px', fontWeight: 'bold', color: '#1565c0'}}>
                                                {priceGrid[season.key].max > 0 ? priceGrid[season.key].max.toFixed(0) : '-'}
                                            </div>
                                        </div>
                                    </div>
                                    <div style={{fontSize: '11px', color: '#a4a4a4', marginTop: '8px', textAlign: 'center'}}>
                                        ‚Ç¨ / nuit
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="mt-4 alert">
                            <p style={{fontSize: '13px', color: '#4b3e12', lineHeight: '1.6'}}>
                                <strong>üí° Comment utiliser :</strong><br/>
                                ‚Ä¢ <strong>MIN</strong> : Prix conservateur pour maximiser l'occupation<br/>
                                ‚Ä¢ <strong>TENDANCE</strong> : Prix √©quilibr√© recommand√© (moyenne du march√©)<br/>
                                ‚Ä¢ <strong>MAX</strong> : Prix premium si votre bien est au-dessus du march√©
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<CompetitiveAnalyzer />, document.getElementById('root'));
    </script>
</body>
</html>
