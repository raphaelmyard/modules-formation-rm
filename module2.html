<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 2 - Analyse Concurrentielle</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; }
        h1 { color: #4b3e12; font-size: 24px; margin-bottom: 8px; }
        h2 { color: #4b3e12; font-size: 18px; margin-bottom: 16px; }
        h3 { color: #4b3e12; font-size: 16px; margin-bottom: 12px; }
        .subtitle { color: #a4a4a4; font-size: 14px; }
        .grid { display: grid; gap: 16px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        label { display: block; font-size: 14px; font-weight: 500; color: #4b3e12; margin-bottom: 8px; }
        input, select { width: 100%; padding: 10px 16px; border: 1px solid #a4a4a4; border-radius: 8px; font-size: 14px; }
        button { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-primary { background: #cdaa36; color: white; }
        .competitor-card { padding: 20px; border-radius: 8px; border: 2px solid #cdaa36; background: #fef9f0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e5e5; }
        th { background: #fef9f0; color: #4b3e12; font-weight: 600; font-size: 14px; }
        td { font-size: 14px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mt-4 { margin-top: 16px; }
        .p-4 { padding: 16px; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 600; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .summary-card { padding: 16px; background: white; border-radius: 8px; border: 1px solid #e5e5e5; text-align: center; }
        .big-number { font-size: 28px; font-weight: bold; color: #cdaa36; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        const CompetitiveAnalyzer = () => {
            // Charger les données depuis localStorage au démarrage
            const loadFromStorage = () => {
                try {
                    const saved = localStorage.getItem('module2_data');
                    if (saved) {
                        return JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Erreur lecture localStorage:', e);
                }
                return null;
            };

            const initialData = loadFromStorage();
            
            const [propertyName, setPropertyName] = useState(initialData?.propertyName || '');
            const [data, setData] = useState(initialData?.data || {
                competitors: Array(5).fill(null).map((_, i) => ({
                    name: `Concurrent ${i + 1}`,
                    airbnbLink: '',
                    bookingLink: '',
                    lowSeason: { 
                        airbnb: { night1: '', night3: '', night7: '' },
                        booking: { night1: '', night3: '', night7: '' }
                    },
                    midSeason: { 
                        airbnb: { night1: '', night3: '', night7: '' },
                        booking: { night1: '', night3: '', night7: '' }
                    },
                    highSeason: { 
                        airbnb: { night1: '', night3: '', night7: '' },
                        booking: { night1: '', night3: '', night7: '' }
                    },
                    events: { 
                        airbnb: { night1: '', night3: '', night7: '' },
                        booking: { night1: '', night3: '', night7: '' }
                    }
                }))
            });

            const seasons = [
                { key: 'lowSeason', label: 'Basse Saison', color: '#87CEEB' },
                { key: 'midSeason', label: 'Moyenne Saison', color: '#FFA500' },
                { key: 'highSeason', label: 'Haute Saison', color: '#FF6347' },
                { key: 'events', label: 'Événementiel', color: '#9370DB' }
            ];

            const durations = [
                { key: 'night1', label: '1 nuit' },
                { key: 'night3', label: '3 nuits' },
                { key: 'night7', label: '7 nuits' }
            ];

            const updateCompetitor = (index, field, value) => {
                const newData = { ...data };
                newData.competitors[index][field] = value;
                setData(newData);
            };

            const updatePrice = (competitorIdx, season, platform, duration, value) => {
                const newData = { ...data };
                newData.competitors[competitorIdx][season][platform][duration] = value;
                setData(newData);
            };

            // Calculs des moyennes
            const calculateAverages = useMemo(() => {
                const result = {};
                
                seasons.forEach(season => {
                    result[season.key] = {
                        airbnb: {},
                        booking: {},
                        global: {}
                    };

                    durations.forEach(duration => {
                        // Airbnb
                        const airbnbPrices = data.competitors
                            .map(c => parseFloat(c[season.key].airbnb[duration.key]))
                            .filter(p => !isNaN(p) && p > 0);
                        const airbnbAvg = airbnbPrices.length > 0 
                            ? airbnbPrices.reduce((a, b) => a + b, 0) / airbnbPrices.length 
                            : 0;
                        const airbnbNet = airbnbAvg * 0.845; // -15.5%

                        // Booking
                        const bookingPrices = data.competitors
                            .map(c => parseFloat(c[season.key].booking[duration.key]))
                            .filter(p => !isNaN(p) && p > 0);
                        const bookingAvg = bookingPrices.length > 0 
                            ? bookingPrices.reduce((a, b) => a + b, 0) / bookingPrices.length 
                            : 0;
                        const bookingNet = bookingAvg * 0.82; // -18%

                        result[season.key].airbnb[duration.key] = { gross: airbnbAvg, net: airbnbNet };
                        result[season.key].booking[duration.key] = { gross: bookingAvg, net: bookingNet };

                        // Moyenne globale (moyenne des nets)
                        const allNets = [airbnbNet, bookingNet].filter(n => n > 0);
                        const globalAvg = allNets.length > 0 
                            ? allNets.reduce((a, b) => a + b, 0) / allNets.length 
                            : 0;
                        result[season.key].global[duration.key] = globalAvg;
                    });
                });

                return result;
            }, [data]);

            // Grille tarifaire recommandée par période
            const priceGrid = useMemo(() => {
                const grid = {};
                seasons.forEach(season => {
                    const prices = durations.map(d => calculateAverages[season.key].global[d.key]).filter(p => p > 0);
                    grid[season.key] = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : 0;
                });
                return grid;
            }, [calculateAverages]);

            const exportToExcel = () => {
                const wb = XLSX.utils.book_new();
                
                // Feuille 1: Données brutes
                const ws1Data = [['ANALYSE CONCURRENTIELLE'], [], ['Bien:', propertyName || 'Non renseigné'], []];
                ws1Data.push(['Concurrent', 'Lien Airbnb', 'Lien Booking', 'Période', 'Durée', 'Prix Airbnb (€)', 'Prix Booking (€)']);
                
                data.competitors.forEach(comp => {
                    seasons.forEach(season => {
                        durations.forEach(duration => {
                            ws1Data.push([
                                comp.name,
                                comp.airbnbLink || '',
                                comp.bookingLink || '',
                                season.label,
                                duration.label,
                                comp[season.key].airbnb[duration.key] || '',
                                comp[season.key].booking[duration.key] || ''
                            ]);
                        });
                    });
                });
                
                const ws1 = XLSX.utils.aoa_to_sheet(ws1Data);
                XLSX.utils.book_append_sheet(wb, ws1, 'Données brutes');
                
                // Feuille 2: Moyennes par plateforme
                const ws2Data = [['MOYENNES PAR PLATEFORME'], [], ['Période', 'Durée', 'Airbnb Brut', 'Airbnb Net (-15.5%)', 'Booking Brut', 'Booking Net (-18%)']];
                
                seasons.forEach(season => {
                    durations.forEach(duration => {
                        const airbnb = calculateAverages[season.key].airbnb[duration.key];
                        const booking = calculateAverages[season.key].booking[duration.key];
                        ws2Data.push([
                            season.label,
                            duration.label,
                            airbnb.gross.toFixed(2),
                            airbnb.net.toFixed(2),
                            booking.gross.toFixed(2),
                            booking.net.toFixed(2)
                        ]);
                    });
                });
                
                const ws2 = XLSX.utils.aoa_to_sheet(ws2Data);
                XLSX.utils.book_append_sheet(wb, ws2, 'Moyennes plateformes');
                
                // Feuille 3: Grille tarifaire recommandée
                const ws3Data = [['GRILLE TARIFAIRE RECOMMANDÉE'], [], ['Période', 'Prix Net Moyen (€)']];
                seasons.forEach(season => {
                    ws3Data.push([season.label, priceGrid[season.key].toFixed(2)]);
                });
                
                const ws3 = XLSX.utils.aoa_to_sheet(ws3Data);
                XLSX.utils.book_append_sheet(wb, ws3, 'Grille tarifaire');
                
                XLSX.writeFile(wb, 'analyse_concurrentielle.xlsx');
            };

            return (
                <div className="container">
                    <div className="mb-4">
                        <h1>Module 2 - Analyse Concurrentielle</h1>
                        <p className="subtitle">Analysez vos concurrents sur Airbnb et Booking pour définir votre grille tarifaire</p>
                    </div>

                    <div className="card">
                        <h2>📋 Votre Bien</h2>
                        <label>Nom du bien</label>
                        <input 
                            type="text" 
                            value={propertyName} 
                            onChange={(e) => setPropertyName(e.target.value)} 
                            placeholder="Ex: Studio Tonnerre De Brest" 
                        />
                    </div>

                    <div className="card">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                            <h2 style={{margin: 0}}>🔍 Vos Concurrents</h2>
                            <button onClick={exportToExcel} className="btn-primary">
                                📥 Export Excel
                            </button>
                        </div>
                        
                        <div style={{padding: '12px', background: '#fef9f0', borderRadius: '8px', marginBottom: '24px', border: '1px solid #cdaa36'}}>
                            <p style={{fontSize: '13px', color: '#4b3e12', lineHeight: '1.6', margin: 0}}>
                                <strong>💡 Conseil :</strong> Le tarif <strong>7 nuits est optionnel</strong>. Si vos concurrents appliquent de grosses réductions hebdomadaires (-20% ou plus), ne remplissez pas cette colonne car cela fausserait la moyenne à la baisse. Concentrez-vous sur les tarifs 1 et 3 nuits qui reflètent mieux le prix au jour.
                            </p>
                        </div>

                        {data.competitors.map((competitor, idx) => (
                            <div key={idx} className="competitor-card mb-4">
                                <div className="grid grid-2 mb-4">
                                    <div>
                                        <label>Nom du concurrent {idx + 1}</label>
                                        <input 
                                            type="text" 
                                            value={competitor.name} 
                                            onChange={(e) => updateCompetitor(idx, 'name', e.target.value)} 
                                            placeholder={`Concurrent ${idx + 1}`}
                                        />
                                    </div>
                                    <div className="grid" style={{gridTemplateColumns: '1fr 1fr', gap: '8px'}}>
                                        <div>
                                            <label>Lien Airbnb</label>
                                            <input 
                                                type="url" 
                                                value={competitor.airbnbLink} 
                                                onChange={(e) => updateCompetitor(idx, 'airbnbLink', e.target.value)} 
                                                placeholder="https://airbnb.com/..."
                                            />
                                        </div>
                                        <div>
                                            <label>Lien Booking</label>
                                            <input 
                                                type="url" 
                                                value={competitor.bookingLink} 
                                                onChange={(e) => updateCompetitor(idx, 'bookingLink', e.target.value)} 
                                                placeholder="https://booking.com/..."
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-4">
                                    {seasons.map(season => (
                                        <div key={season.key}>
                                            <h3 style={{fontSize: '14px', marginBottom: '12px', color: season.color}}>
                                                {season.label}
                                            </h3>
                                            {durations.map(duration => (
                                                <div key={duration.key} className="mb-2">
                                                    <label style={{fontSize: '12px'}}>{duration.label}</label>
                                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '4px'}}>
                                                        <input 
                                                            type="number" 
                                                            value={competitor[season.key].airbnb[duration.key]} 
                                                            onChange={(e) => updatePrice(idx, season.key, 'airbnb', duration.key, e.target.value)} 
                                                            placeholder="Airbnb"
                                                            style={{fontSize: '12px', padding: '6px 8px'}}
                                                        />
                                                        <input 
                                                            type="number" 
                                                            value={competitor[season.key].booking[duration.key]} 
                                                            onChange={(e) => updatePrice(idx, season.key, 'booking', duration.key, e.target.value)} 
                                                            placeholder="Booking"
                                                            style={{fontSize: '12px', padding: '6px 8px'}}
                                                        />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="card">
                        <h2>📊 Analyse des Prix par Plateforme</h2>
                        <div style={{overflowX: 'auto'}}>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Période</th>
                                        <th>Durée</th>
                                        <th className="text-center">Airbnb Brut (€)</th>
                                        <th className="text-center">Airbnb Net -15.5% (€)</th>
                                        <th className="text-center">Booking Brut (€)</th>
                                        <th className="text-center">Booking Net -18% (€)</th>
                                        <th className="text-center" style={{background: '#cdaa36', color: 'white'}}>Moyenne Globale (€)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {seasons.map(season => 
                                        durations.map((duration, dIdx) => {
                                            const airbnb = calculateAverages[season.key].airbnb[duration.key];
                                            const booking = calculateAverages[season.key].booking[duration.key];
                                            const global = calculateAverages[season.key].global[duration.key];
                                            
                                            return (
                                                <tr key={`${season.key}-${duration.key}`}>
                                                    {dIdx === 0 && (
                                                        <td rowSpan={3} style={{fontWeight: '600', color: season.color}}>
                                                            {season.label}
                                                        </td>
                                                    )}
                                                    <td>{duration.label}</td>
                                                    <td className="text-center" style={{color: '#a4a4a4'}}>
                                                        {airbnb.gross > 0 ? airbnb.gross.toFixed(2) : '-'}
                                                    </td>
                                                    <td className="text-center" style={{color: '#4b3e12', fontWeight: '500'}}>
                                                        {airbnb.net > 0 ? airbnb.net.toFixed(2) : '-'}
                                                    </td>
                                                    <td className="text-center" style={{color: '#a4a4a4'}}>
                                                        {booking.gross > 0 ? booking.gross.toFixed(2) : '-'}
                                                    </td>
                                                    <td className="text-center" style={{color: '#4b3e12', fontWeight: '500'}}>
                                                        {booking.net > 0 ? booking.net.toFixed(2) : '-'}
                                                    </td>
                                                    <td className="text-center font-bold" style={{color: '#cdaa36', background: '#fef9f0'}}>
                                                        {global > 0 ? global.toFixed(2) : '-'}
                                                    </td>
                                                </tr>
                                            );
                                        })
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="card">
                        <h2>🎯 Grille Tarifaire Recommandée</h2>
                        <p className="subtitle mb-4">Prix nets moyens à appliquer par période (toutes plateformes confondues)</p>
                        
                        <div className="summary-grid">
                            {seasons.map(season => (
                                <div key={season.key} className="summary-card" style={{borderColor: season.color, borderWidth: '2px'}}>
                                    <div style={{fontSize: '14px', fontWeight: '600', color: season.color, marginBottom: '8px'}}>
                                        {season.label}
                                    </div>
                                    <div className="big-number">
                                        {priceGrid[season.key] > 0 ? priceGrid[season.key].toFixed(2) : '-'}
                                    </div>
                                    <div style={{fontSize: '12px', color: '#a4a4a4', marginTop: '4px'}}>
                                        € / nuit
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="mt-4 p-4" style={{background: '#fef9f0', borderRadius: '8px', borderLeft: '4px solid #cdaa36'}}>
                            <p style={{fontSize: '13px', color: '#4b3e12', lineHeight: '1.6'}}>
                                <strong>💡 Comment utiliser ces prix :</strong><br/>
                                Ces prix nets représentent ce que vous recevrez réellement après commissions. 
                                Utilisez ces montants comme base pour votre Module 3 (Calendrier Tarifaire). 
                                Ajustez selon votre positionnement (premium = +10-20%, économique = -10-15%).
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<CompetitiveAnalyzer />, document.getElementById('root'));
    </script>
</body>
</html>
